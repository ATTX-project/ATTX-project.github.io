
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Containerized Testing Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-git-author/style.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="Build-Environment-Setup.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">ATTX Project</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    ATTX Project
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Applications and Use Cases
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="Use-case-Infrastructures-and-publications.html">
            
                <a href="Use-case-Infrastructures-and-publications.html">
            
                    
                    UC1 - Infrastructure and Publications
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="Use-case-Jyvaskyla.html">
            
                <a href="Use-case-Jyvaskyla.html">
            
                    
                    UC2 - Parallel Publication Dashboard
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="Use-case-Metax.html">
            
                <a href="Use-case-Metax.html">
            
                    
                    UC3 - Metax
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="Use-case-Mildred.html">
            
                <a href="Use-case-Mildred.html">
            
                    
                    UC4 - Mildred
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="ATTX-Architecture-Overview.html">
            
                <a href="ATTX-Architecture-Overview.html">
            
                    
                    ATTX Architecture Overview
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Getting Started</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="ATTX-Broker-Deployment.html">
            
                <a href="ATTX-Broker-Deployment.html">
            
                    
                    ATTX Broker Deployment
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" >
            
                <span>
            
                    
                    Run on Single Machine PC/Mac/VM
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1.1" data-path="Building-Docker-application-stacks-in-Swarm-Mode.html">
            
                <a href="Building-Docker-application-stacks-in-Swarm-Mode.html">
            
                    
                    Building Swarm Mode on a PC/Mac
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.2" data-path="Running-the-ATTX-containerised-application-stack-in-your-own-PC-or-Mac.html">
            
                <a href="Running-the-ATTX-containerised-application-stack-in-your-own-PC-or-Mac.html">
            
                    
                    Running the ATTX Stack on a PC/Mac
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.1.2" >
            
                <span>
            
                    
                    Run on Distributed/Cloud
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.2.1" data-path="Provisioning-ATTX-Components-on-CSC-Open-Stack-cPouta.html">
            
                <a href="Provisioning-ATTX-Components-on-CSC-Open-Stack-cPouta.html">
            
                    
                    Provisioning ATTX Components on CSC Open Stack (cPouta)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2.2" data-path="Deploying-ATTX-Components-on-Docker-Swarm.html">
            
                <a href="Deploying-ATTX-Components-on-Docker-Swarm.html">
            
                    
                    Deploying ATTX Components on Docker Swarm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2.3" data-path="Shared-NFS-Swarm-Cloud.html">
            
                <a href="Shared-NFS-Swarm-Cloud.html">
            
                    
                    Setting-up a shared NFS filesystem in Docker Swarm running in CSC cPouta
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2.4" data-path="Applying-Rolling-Updates-to-services-in-Docker-Swarm.html">
            
                <a href="Applying-Rolling-Updates-to-services-in-Docker-Swarm.html">
            
                    
                    Applying Rolling Updates to Services in Docker Swarm
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="Deploying-ATTX-SB-on-Kontena.html">
            
                <a href="Deploying-ATTX-SB-on-Kontena.html">
            
                    
                    Deploying ATTX Broker on Kontena
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Core Components</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="ATTX-Component-Workflow.html">
            
                <a href="ATTX-Component-Workflow.html">
            
                    
                    Workflow Component
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="ETL-Artifacts.html">
            
                <a href="ETL-Artifacts.html">
            
                    
                    ETL Artifacts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="Unified-Views-plugins.html">
            
                <a href="Unified-Views-plugins.html">
            
                    
                    UnifiedViews Plugins
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="Service-UVProvenance.html">
            
                <a href="Service-UVProvenance.html">
            
                    
                    UVProvovenance Service
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="ATTX-Component-Graph.html">
            
                <a href="ATTX-Component-Graph.html">
            
                    
                    Graph Component
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1" data-path="Service-Graph-Manager.html">
            
                <a href="Service-Graph-Manager.html">
            
                    
                    Graph Manager Service
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1.1" data-path="Examples-Graph-Manager-Service.html">
            
                <a href="Examples-Graph-Manager-Service.html">
            
                    
                    Graph Manager Message Examples
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.2.2" data-path="Graph-Store.html">
            
                <a href="Graph-Store.html">
            
                    
                    Graph Store
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.2.1" data-path="ATTX-Data-Model.html">
            
                <a href="ATTX-Data-Model.html">
            
                    
                    Ontology/Data model
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.2.3" data-path="Linking-Strategies.html">
            
                <a href="Linking-Strategies.html">
            
                    
                    Linking Strategies
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="ATTX-Component-Distribution.html">
            
                <a href="ATTX-Component-Distribution.html">
            
                    
                    Distribution Component
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.3.1" data-path="ElasticSearch-with-Siren.html">
            
                <a href="ElasticSearch-with-Siren.html">
            
                    
                    ElasticSearch 1.3 with Siren
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.2" data-path="ElasticSearch-5.html">
            
                <a href="ElasticSearch-5.html">
            
                    
                    ElasticSearch 5.x
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.3" data-path="Dissemination-Workflow.html">
            
                <a href="Dissemination-Workflow.html">
            
                    
                    How Dissemination worflows work
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="ATTX-Component-ServiceDiscovery.html">
            
                <a href="ATTX-Component-ServiceDiscovery.html">
            
                    
                    Service Discovery
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.4.1" data-path="Consul-ServiceDiscovery-Implementation.html">
            
                <a href="Consul-ServiceDiscovery-Implementation.html">
            
                    
                    Consul Service Discovery Implementation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4.2" data-path="Consul-for-Service-Discovery-on-Docker-Swarm.html">
            
                <a href="Consul-for-Service-Discovery-on-Docker-Swarm.html">
            
                    
                    Consul for Service Discovery on Docker Swarm
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="ATTX-Component-MessageBroker.html">
            
                <a href="ATTX-Component-MessageBroker.html">
            
                    
                    Message Broker
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.5.1" data-path="MessageBroker-ActiveMQ.html">
            
                <a href="MessageBroker-ActiveMQ.html">
            
                    
                    ActiveMQ Message Broker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5.2" data-path="MessageBroker-RabbitMQ.html">
            
                <a href="MessageBroker-RabbitMQ.html">
            
                    
                    RabbitMQ Message Broker
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Broker Services</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="Service-Provenance.html">
            
                <a href="Service-Provenance.html">
            
                    
                    Provenance Service
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="Examples-Provenance-Service.html">
            
                <a href="Examples-Provenance-Service.html">
            
                    
                    Provenance Messages Examples
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="Service-RML.html">
            
                <a href="Service-RML.html">
            
                    
                    RML Service
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.2.1" data-path="Examples-RML-Service.html">
            
                <a href="Examples-RML-Service.html">
            
                    
                    RML Messages Examples
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="Service-Indexing.html">
            
                <a href="Service-Indexing.html">
            
                    
                    Indexing Service
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.3.1" data-path="Examples-Indexing-Service.html">
            
                <a href="Examples-Indexing-Service.html">
            
                    
                    Indexing Messages Examples
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="Service-Graph-Framing.html">
            
                <a href="Service-Graph-Framing.html">
            
                    
                    Graph Framing Service
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.4.1" data-path="Examples-Graph-Framing-Service.html">
            
                <a href="Examples-Graph-Framing-Service.html">
            
                    
                    Graph Framing Messages Examples
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">User Guide</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="User-Guide-Administrator.html">
            
                <a href="User-Guide-Administrator.html">
            
                    
                    Data Administrator's User guide
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Development Guidelines</li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="ATTX-Development-Environment.html">
            
                <a href="ATTX-Development-Environment.html">
            
                    
                    ATTX Development Environment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="Feature-roadmap.html">
            
                <a href="Feature-roadmap.html">
            
                    
                    Feature Roadmap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="Release-Plan.html">
            
                <a href="Release-Plan.html">
            
                    
                    Release Plan
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.4" data-path="CI-CD-Enviroment.html">
            
                <a href="CI-CD-Enviroment.html">
            
                    
                    CI/CD Enviroment
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.4.1" data-path="Jenkins-CI.html">
            
                <a href="Jenkins-CI.html">
            
                    
                    Jenkins CI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.4.2" data-path="Build-Environment-Setup.html">
            
                <a href="Build-Environment-Setup.html">
            
                    
                    Build Environment Setup
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="6.4.3" data-path="Containerized-testing.html">
            
                <a href="Containerized-testing.html">
            
                    
                    Containerized Testing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Reports & Contributions</li>
        
        
    
        <li class="chapter " data-level="7.1" >
            
                <span>
            
                    
                    Reports
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="7.1.1" data-path="CSC-cPouta-Cloud-Services-Report.html">
            
                <a href="CSC-cPouta-Cloud-Services-Report.html">
            
                    
                    CSC cPouta Cloud Services Report
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.1.2" data-path="Building-with-Gradle.html">
            
                <a href="Building-with-Gradle.html">
            
                    
                    Building with (Py)Gradle
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.1.3" data-path="Messaging-Brokers-Solutions.html">
            
                <a href="Messaging-Brokers-Solutions.html">
            
                    
                    Messaging Brokers Solutions Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.1.4" data-path="Service-Discovery-Solutions.html">
            
                <a href="Service-Discovery-Solutions.html">
            
                    
                    Service Discovery Solutions Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.1.5" data-path="Workflow-Management-Tools.html">
            
                <a href="Workflow-Management-Tools.html">
            
                    
                    Workflow Management Tools Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.1.6" data-path="Solutions-API-Gateway.html">
            
                <a href="Solutions-API-Gateway.html">
            
                    
                    API Gateway Solutions Overview
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="7.2" >
            
                <span>
            
                    
                    Presentations
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="7.2.1" data-path="Presentation-ELAG-2017.html">
            
                <a href="Presentation-ELAG-2017.html">
            
                    
                    ELAG2017
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.2.2" data-path="Presentation-OSFair-2017.html">
            
                <a href="Presentation-OSFair-2017.html">
            
                    
                    OSFair2017
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.2.3" data-path="Presentation-SWIB-2017.html">
            
                <a href="Presentation-SWIB-2017.html">
            
                    
                    SWIB2017
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.2.4" data-path="Presentation-ISWC-2017.html">
            
                <a href="Presentation-ISWC-2017.html">
            
                    
                    ISWC2017
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="7.3" data-path="Open-Contributions.html">
            
                <a href="Open-Contributions.html">
            
                    
                    Open Source Contributions
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="8.1" >
            
                <a target="_blank" href="https://www.helsinki.fi/en/projects/attx-2016">
            
                    
                    ATTX website
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Containerized Testing</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div class="git-author-container git-author-top"><div class="modified">Current page last modified at: 07-Dec-2017 12:32:44</div></div><h1 id="containerised-testing">Containerised Testing</h1>
<p>This page describes the necessary steps required to run integration/BDD tests within a container or local environment alongside any required services running in their own containers.</p>
<h3 id="table-of-contents">Table of Contents<!-- TOC START min:1 max:3 link:true update:false --></h3>
<ul>
<li><a href="#testing-workflow">Testing Workflow</a></li>
<li><a href="#testing-with-gradle">Testing with Gradle</a></li>
<li><a href="#structure-of-feature-test-images">Structure of Feature-test Images</a><ul>
<li><a href="#runtestssh-script">runTests.sh Script</a></li>
<li><a href="#gradle-build-files">Gradle Build Files</a></li>
<li><a href="#dockerfile-description">Dockerfile Description</a></li>
<li><a href="#configuring-jenkins">Configuring Jenkins</a></li>
</ul>
</li>
<li><a href="#running-tests-against-custom-images">Running Tests Against Custom Images</a></li>
<li><a href="#developing-tests">Developing Tests</a></li>
</ul>
<!-- TOC END -->
<p>Platform Tests repository: <a href="https://github.com/ATTX-project/platform-tests" target="_blank">https://github.com/ATTX-project/platform-tests</a></p>
<h2 id="testing-workflow">Testing Workflow</h2>
<p>Overview of the steps performed during the test suite:</p>
<ul>
<li>Start all required Semantic Broker containers</li>
<li>Wait for the services to come up</li>
<li>Build test container (only during the containerised testing task)</li>
<li>Start test container (only during the containerised testing task)</li>
<li>Build and Run tests</li>
<li>Export reports to the host machine</li>
<li>Stop all containers</li>
<li>The build is Successful or Failed depending on the results form the test container</li>
</ul>
<h2 id="testing-with-gradle">Testing with Gradle</h2>
<p>There are two tasks for running the tests:</p>
<ul>
<li><code>runIntegTests</code> -  for running the test in the local environment with all the ports exposed, thus allowing for rapid development; It will also start the containers needed, by default they will expose ports; Adding a <code>-PrunEnv=console</code> parameter will allow for continuous testing without removing any of the started containers;</li>
<li><code>runContainerTests</code> - for running tests in the CI environment or a closed test setup, and for this one needs the Gradle property <code>-PtestEnv=CI</code>. This task will build and run the tests inside a container on the same network as the other containers without the need of exposing all the ports.</li>
</ul>
<p>Running the tests inside the container:</p>
<ul>
<li><code>gradle -PregistryURL=attx-dev:5000 -PsnapshotRepoURL=http://attx-dev:8081 -PtestEnv=CI clean runContainerTests</code></li>
</ul>
<p>Run the test locally and exposing the ports. At the end of the tests the containers are removed:</p>
<ul>
<li><code>gradle -PregistryURL=attx-dev:5000 -PsnapshotRepoURL=http://attx-dev:8081 -PtestEnv=dev clean runIntegTests</code></li>
</ul>
<p>Run the test locally from console and exposing the container ports:</p>
<ul>
<li><code>gradle -PregistryURL=attx-dev:5000 -PsnapshotRepoURL=http://attx-dev:8081 -PtestEnv=dev -PrunEnv=console clean runIntegTests</code></li>
</ul>
<p>Running a specific test class:</p>
<ul>
<li><code>gradle -PregistryURL=attx-dev:5000 -PartifactRepoURL=http://attx-dev:8081 -PtestEnv=dev -PrunEnv=console runIntegTests --tests org.uh.attx.platform.test.GraphManagerIntegrationTest</code></li>
</ul>
<p>Test reports are exported to the folder configured in <code>copyReportFiles</code> task (default <code>$buildDir/reports/</code>).</p>
<h2 id="structure-of-feature-test-images">Structure of Feature-test Images</h2>
<h3 id="runtestssh-script">runTests.sh Script</h3>
<p>This script is the starting point for a <code>testContainer</code>. It first checks and waits (for a limited time) for certain ports in the network to become available and then runs the test suite.
<strong>TO DO</strong>
In the future, the goal is to use Service discovery component to query for up-and-running services.</p>
<p>Example: Waiting for services to be available:</p>
<pre><code class="lang-bash">dockerize -wait tcp://mysql:3306 -timeout 240s
dockerize -wait http://fuseki:3030 -timeout 60s
dockerize -wait http://gmapi:4302/health -timeout 60s
</code></pre>
<p><a href="https://github.com/jwilder/dockerize" target="_blank">Dockerize (Github)</a></p>
<p>These checks and waits are complementary to the ones done in the Gradle script and the reason is that some tests need to have some fixture in place (e.g. ATTX DPU) which also wait for other services to start. Thus the tests need to have everything ready before starting, meaning the last dependent container needs to finish before running.</p>
<p>If the time-out is reached and the service is still not available, the process exits with status code 1.</p>
<h3 id="gradle-build-files">Gradle Build Files</h3>
<p>Test project contains two Gradle configurations, one for developing tests and managing containers and the other one for running tests inside the container; these are <code>build.gradle</code> and <code>build.test.gradle</code> respectively.</p>
<p><strong>build.gradle</strong></p>
<p>Example of the most relevant parts:</p>
<pre><code class="lang-groovy">
<span class="hljs-comment">/* === Setting Configuration for the Test Environments === */</span>

ext {
    testTag           = <span class="hljs-string">&quot;dev&quot;</span>
    testImageGM       = <span class="hljs-string">&quot;${testTag}&quot;</span>
    testImageFuseki   = <span class="hljs-string">&quot;${testTag}&quot;</span>
<span class="hljs-comment">//    We are testing images tagged with dev on the public Docker Hub</span>
    imageBase         = (<span class="hljs-string">&quot;${testTag}&quot;</span> == <span class="hljs-string">&quot;dev&quot;</span>) ?  &quot;attxproject&quot; : <span class="hljs-string">&quot;${imageRepo}:${imageRepoPort}&quot;</span>

ext.src = [
    <span class="hljs-string">&quot;${artifactRepoURL}/restServices/archivaServices/searchService/artifact?g=org.uh.hulib.attx.wc.uv&amp;a=attx-l-replaceds&amp;v=${uvreplaceDS}&amp;p=jar&quot;</span>:<span class="hljs-string">&quot;attx-l-replaceds-${uvreplaceDS}.jar&quot;</span>
]

<span class="hljs-keyword">import</span> de.undercouch.gradle.tasks.download.Download
task downloadTestFiles

<span class="hljs-keyword">for</span> (s <span class="hljs-keyword">in</span> src) {
    task <span class="hljs-string">&quot;downloadTestFiles_${s.key.hashCode()}&quot;</span>(<span class="hljs-string">type:</span> Download) {
        src s.key
        dest <span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;$projectDir&quot;</span>, s.value)
    }
    downloadTestFiles.dependsOn(<span class="hljs-string">&quot;downloadTestFiles_${s.key.hashCode()}&quot;</span>)
}


<span class="hljs-keyword">if</span> (!project.hasProperty(<span class="hljs-string">&quot;testEnv&quot;</span>) || project.testEnv == <span class="hljs-string">&quot;dev&quot;</span>) {
    ext.testSet = <span class="hljs-string">&quot;localhost&quot;</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (project.testEnv == <span class="hljs-string">&quot;CI&quot;</span>){
    ext.testSet = <span class="hljs-string">&quot;container&quot;</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> GradleException(<span class="hljs-string">&quot;Build project environment option not recognised.&quot;</span>)
}

<span class="hljs-keyword">if</span> (!project.hasProperty(<span class="hljs-string">&quot;volumeDir&quot;</span>)) {
    ext.volumeDir = <span class="hljs-string">&quot;/attx-sb-shared/data&quot;</span>
} <span class="hljs-keyword">else</span> {
    ext.volumeDir = project.volumeDir
}

<span class="hljs-keyword">def</span> data = <span class="hljs-string">&quot;&quot;</span>

<span class="hljs-keyword">def</span> loadConfiguration() {
    <span class="hljs-keyword">def</span> jsonSlurper = <span class="hljs-keyword">new</span> JsonSlurper()
    <span class="hljs-keyword">def</span> reader = <span class="hljs-keyword">new</span> BufferedReader(<span class="hljs-keyword">new</span> InputStreamReader(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;$project.projectDir/testEnv.json&quot;</span>), <span class="hljs-string">&quot;UTF-8&quot;</span>))
    <span class="hljs-keyword">def</span> data = jsonSlurper.parse(reader)
    <span class="hljs-keyword">return</span> data
}

<span class="hljs-keyword">if</span> (project.hasProperty(<span class="hljs-string">&quot;network&quot;</span>)) {
    ext.testNetwork = project.network
    data = loadConfiguration()
} <span class="hljs-keyword">else</span> {
    ext.testNetwork = <span class="hljs-string">&quot;pdTest&quot;</span>
    data = loadConfiguration()
}

<span class="hljs-keyword">def</span> base = data.networks.<span class="hljs-string">&quot;${testNetwork}&quot;</span>.baseImage

<span class="hljs-comment">/* === Build the Images and Environments === */</span>

dcompose {
    createComposeFile.useTags = <span class="hljs-literal">true</span>
    registry (<span class="hljs-string">&quot;$registryURL&quot;</span>) {
        <span class="hljs-comment">// no user/pass</span>
    }
    networks {
      pdTest
    }

    messagebroker {
        forcePull = <span class="hljs-literal">true</span>
        forceRemoveImage = <span class="hljs-literal">true</span>
        image = <span class="hljs-string">&apos;rabbitmq:3.6.12-management&apos;</span>
        networks = [pdTest]
        <span class="hljs-keyword">if</span> (testSet == <span class="hljs-string">&quot;localhost&quot;</span>) {
            portBindings = [<span class="hljs-string">&apos;4369:4369&apos;</span>,<span class="hljs-string">&apos;5671:5671&apos;</span>, <span class="hljs-string">&apos;5672:5672&apos;</span>, <span class="hljs-string">&apos;15671:15671&apos;</span>, <span class="hljs-string">&apos;15672:15672&apos;</span>, <span class="hljs-string">&apos;25672:25672&apos;</span>]
        }
        env = [<span class="hljs-string">&apos;RABBITMQ_DEFAULT_USER=user&apos;</span>, <span class="hljs-string">&apos;RABBITMQ_DEFAULT_PASS=password&apos;</span>]
    }

    fuseki {
        forcePull = <span class="hljs-literal">true</span>
        forceRemoveImage = <span class="hljs-literal">true</span>
        image = <span class="hljs-string">&quot;${imageBase}/attx-fuseki:${testImageFuseki}&quot;</span>
        networks = [pdTest]
        hostName = <span class="hljs-string">&apos;fuseki&apos;</span>
        <span class="hljs-keyword">if</span> (testSet == <span class="hljs-string">&quot;localhost&quot;</span>) {
            portBindings = [<span class="hljs-string">&apos;3030:3030&apos;</span>]
        }
        env = [<span class="hljs-string">&apos;ADMIN_PASSWORD=pw123&apos;</span>]
    }


    graphmanager {
        forcePull = <span class="hljs-literal">true</span>
        forceRemoveImage = <span class="hljs-literal">true</span>
        image = <span class="hljs-string">&quot;${imageBase}/gm-api:${testImageGM}&quot;</span>
        <span class="hljs-keyword">def</span> dependlist = []
        <span class="hljs-keyword">if</span> ( base == <span class="hljs-string">&quot;graphmanager&quot;</span>) {
            data.networks.<span class="hljs-string">&quot;${testNetwork}&quot;</span>.dependencies.each{dependlist.add(service(<span class="hljs-string">&quot;${it}&quot;</span>))}
        } <span class="hljs-keyword">else</span> {
            dependlist = [messagebroker, fuseki]
        }
        dependsOn = dependlist
        networks = [network(<span class="hljs-string">&quot;${testNetwork}&quot;</span>)]
        env = [<span class="hljs-string">&apos;MHOST=messagebroker&apos;</span>, <span class="hljs-string">&apos;GHOST=fuseki&apos;</span>]
        volumes = [<span class="hljs-string">&apos;/attx-sb-shared&apos;</span>]
        <span class="hljs-keyword">if</span> (testSet == <span class="hljs-string">&quot;localhost&quot;</span>) {
            portBindings = [<span class="hljs-string">&apos;4302:4302&apos;</span>]
        }
        binds = [<span class="hljs-string">&quot;${volumeDir}:/attx-sb-shared:rw&quot;</span>]
    }

    test {
        ignoreExitCode = <span class="hljs-literal">true</span>
        baseDir = file(<span class="hljs-string">&apos;.&apos;</span>)
        dockerFilename = <span class="hljs-string">&apos;Dockerfile&apos;</span>
        buildArgs = [<span class="hljs-string">&apos;UVreplaceDS&apos;</span>: <span class="hljs-string">&quot;$uvreplaceDS&quot;</span>]
        env = [<span class="hljs-string">&quot;REPO=$artifactRepoURL&quot;</span>]
        <span class="hljs-keyword">if</span> (testSet == <span class="hljs-string">&quot;container&quot;</span>) {
            binds = [<span class="hljs-string">&quot;/var/run/docker.sock:/run/docker.sock&quot;</span>]
        }
        dependsOn = [graphmanager] <span class="hljs-comment">// This dependency is not really needed however it reminds the scope of the tests.</span>
        command = [<span class="hljs-string">&apos;sh&apos;</span>, <span class="hljs-string">&apos;-c&apos;</span>, <span class="hljs-string">&apos;/tmp/runTests.sh&apos;</span>]
        waitForCommand = <span class="hljs-literal">true</span>
        forceRemoveImage = <span class="hljs-literal">true</span>
        attachStdout = <span class="hljs-literal">true</span>
        attachStderr = <span class="hljs-literal">true</span>
        networks = [pdTest]
        volumes = [<span class="hljs-string">&apos;/attx-sb-shared&apos;</span>]
        binds = [<span class="hljs-string">&quot;${volumeDir}:/attx-sb-shared:rw&quot;</span>]
    }
}

task copyFilesIntoContainer(<span class="hljs-string">type:</span> DockerCopyFileToContainer) {
    targetContainerId { dcompose.graphmanager.containerId }
    hostPath = <span class="hljs-string">&quot;$projectDir/src/test/resources/data/&quot;</span>
    remotePath = <span class="hljs-string">&quot;/attx-sb-shared/&quot;</span>
}

task copyReportFiles(<span class="hljs-string">type:</span> DcomposeCopyFileFromContainerTask) {
    service = dcompose.test
    containerPath = <span class="hljs-string">&apos;/tmp/build/reports/tests&apos;</span>
    destinationDir = file(<span class="hljs-string">&quot;build/reports/&quot;</span>)
    cleanDestinationDir = <span class="hljs-literal">false</span>
}

startTestContainer.finalizedBy copyReportFiles


<span class="hljs-comment">// making sure the that fresh build of test classes is done before building the image</span>
<span class="hljs-comment">// Other prerequisites for the tests (e.g. artifacts) should be added here.</span>
buildTestImage.dependsOn downloadTestFiles
buildTestImage.dependsOn testClasses

task checkDPUDone(<span class="hljs-string">type:</span> DockerWaitContainer) {
    dependsOn startGmapiContainer
    targetContainerId {dcompose.attxdpus.containerId}
    doLast{
        <span class="hljs-keyword">if</span>(getExitCode() != <span class="hljs-number">0</span>) {
            println <span class="hljs-string">&quot;ATTX DPU Container failed with exit code \${getExitCode()}&quot;</span>
        } <span class="hljs-keyword">else</span> {
            println <span class="hljs-string">&quot;Everything is peachy.&quot;</span>
        }
    }
}

startTestContainer.dependsOn checkDPUDone

task runContainerTests {
    dependsOn startTestContainer
    finalizedBy removeImages
    doLast {
        <span class="hljs-keyword">if</span>(dcompose.test.exitCode != <span class="hljs-number">0</span>){ <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> GradleException(<span class="hljs-string">&quot;Tests within the container Failed!&quot;</span>) }
    }
}
</code></pre>
<p><code>dcompose</code> task configuration is first used to reference all the images required by the tests. In the example, test will require only the container (e.g. <code>graphmanager</code>) that is the object of the tests, meanwhile the container that is the object of the tests will require the additional containers (<code>fuseki</code>, <code>messagebroker</code> and <code>graphmanager</code>) in addition to the test container.
Service configurations should include at least <code>image</code> and in order to run the tests in a local environment the <code>portBindings</code> properties. Test container configuration is mostly same for all the test projects.</p>
<p>Rest of the configuration is the same for all the test projects (assuming that test container is always called <code>test</code>). <code>copyReportFiles</code> task copies report files from inside the container to the build/from-container directory.</p>
<p><code>downloadTestFiles</code> downloads the <code>dev-test-helper</code> artifact as the CI cannot download the artifact from inside the container without having the artifact repository (Archiva) exposed publicly or on the same container network as the <code>dcompose</code> task network.</p>
<p><strong>(not used as the tests are build and run inside the test container)</strong> <code>ShadowJar</code> task create one big jar with all the dependencies required to run the tests, which allows us to run Gradle within in the container in offline mode, which does not trigger dependency downloads (faster). Other option would have been to attach a volume with the preloaded dependencies, but that would also required maintenance.  </p>
<p>Dependencies are loaded from the &#xFC;berjar created by the <code>shadowJar</code> task in the <code>build.gradle</code>. This jar and classes directory includes everything that is needed to run the tests, so we can actually run Gradle in the offline mode (<code>--offline</code>). Building step is faster, since we don&apos;t have to download all the dependencies every time the tests are run.
In order to use the <code>shadowJar</code> the following are required in the build file:</p>
<pre><code class="lang-groovy">shadowJar {
    classifier = <span class="hljs-string">&apos;tests&apos;</span>
    from sourceSets.test.output
    configurations = [project.configurations.testRuntime]
}
buildTestImage.dependsOn shadowJar
</code></pre>
<p><code>checkDPUDone</code> waits for the ATTX DPUS to be added to the front-end where there is a need for such test fixtures. The ATTX DPU waits for MySQL  (for about 4 minutes to be up) in order to add the DPU. If everything is OK the exit code of that container will be (By convention, an &apos;exit 0&apos; indicates success - <a href="http://www.tldp.org/LDP/abs/html/exit-status.html" target="_blank">http://www.tldp.org/LDP/abs/html/exit-status.html</a>). The same strategy is used to check the Tests fail or not inside the container - if the exit code is <code>0</code> the tests were successful if not the tests failed.</p>
<p>The <code>testEnv.json</code> configuration file can have the following structure:</p>
<pre><code class="lang-json">{
    <span class="hljs-string">&quot;networks&quot;</span>: {
        <span class="hljs-string">&quot;pdTest&quot;</span>: {
            <span class="hljs-string">&quot;baseImage&quot;</span>: <span class="hljs-string">&quot;graphmanager&quot;</span>,
            <span class="hljs-string">&quot;dependencies&quot;</span>: [
                <span class="hljs-string">&quot;messagebroker&quot;</span>,
                <span class="hljs-string">&quot;provservice&quot;</span>,
                <span class="hljs-string">&quot;indexservice&quot;</span>,
                <span class="hljs-string">&quot;ldframe&quot;</span>,
                <span class="hljs-string">&quot;uvprov&quot;</span>,
                <span class="hljs-string">&quot;rmlservice&quot;</span>,
                <span class="hljs-string">&quot;attxdpus&quot;</span>,
                <span class="hljs-string">&quot;es5&quot;</span>,
                <span class="hljs-string">&quot;testdata&quot;</span>
            ]
        },
        <span class="hljs-string">&quot;gmTest&quot;</span>: {
            <span class="hljs-string">&quot;baseImage&quot;</span>: <span class="hljs-string">&quot;graphmanager&quot;</span>,
            <span class="hljs-string">&quot;dependencies&quot;</span>: [
                <span class="hljs-string">&quot;messagebroker&quot;</span>,
                <span class="hljs-string">&quot;provservice&quot;</span>,
                <span class="hljs-string">&quot;indexservice&quot;</span>,
                <span class="hljs-string">&quot;ldframe&quot;</span>,
                <span class="hljs-string">&quot;uvprov&quot;</span>,
                <span class="hljs-string">&quot;rmlservice&quot;</span>,
                <span class="hljs-string">&quot;attxdpus&quot;</span>,
                <span class="hljs-string">&quot;es5&quot;</span>
            ]
        }
    }
}
</code></pre>
<p><strong>build.test.gradle</strong></p>
<p>This is a very minimal build file that basically only includes dependency configuration.</p>
<p>The system properties are required to be set in the container and these need to be the same as the <code>hostName</code> of the containers so that are no conflicts when accessing them in the network. The solution of having them inside the Gradle configurations instead of the test code is a decision of keeping the implementation independent of the configuration of the containers.</p>
<p>Another reason is to allow for the tests to be run in local environment, meaning the ports are exposed and the tests need to take into consideration that the requests make inside the network between containers need to be done under the <code>hostName</code> of the specific containers (e.g. no <a href="http://localhost:4301/health" target="_blank">http://localhost:4301/health</a> but instead <a href="http://wfapi:4301/health" target="_blank">http://wfapi:4301/health</a>).</p>
<pre><code class="lang-groovy">plugins {
    id <span class="hljs-string">&quot;java&quot;</span>
}

repositories {
    mavenCentral()
}

dependencies {
    testCompile \
            files(<span class="hljs-string">&quot;/tmp/uv-common-1.0-SNAPSHOT.jar&quot;</span>),
            <span class="hljs-string">&apos;org.apache.commons:commons-io:1.3.2&apos;</span>,
            <span class="hljs-string">&apos;com.fasterxml.jackson.core:jackson-databind:2.9.2&apos;</span>,
            <span class="hljs-string">&apos;com.fasterxml.jackson.core:jackson-core:2.9.2&apos;</span>,
            <span class="hljs-string">&apos;org.junit.jupiter:junit-jupiter-api:5.0.0&apos;</span>,
            <span class="hljs-string">&apos;org.junit.platform:junit-platform-runner:1.0.1&apos;</span>,
            <span class="hljs-string">&apos;info.cukes:cucumber-java8:1.2.5&apos;</span>,
            <span class="hljs-string">&apos;info.cukes:cucumber-junit:1.2.5&apos;</span>,
            <span class="hljs-string">&apos;com.mashape.unirest:unirest-java:1.4.9&apos;</span>,
            <span class="hljs-string">&apos;org.skyscreamer:jsonassert:1.5.0&apos;</span>,
            <span class="hljs-string">&apos;org.awaitility:awaitility-groovy:3.0.0&apos;</span>,
            <span class="hljs-string">&apos;com.rabbitmq:amqp-client:4.2.0&apos;</span>,
            <span class="hljs-string">&apos;org.jdom:jdom2:2.0.5&apos;</span>,
            <span class="hljs-string">&apos;org.apache.jena:jena-core:3.4.0&apos;</span>
    testRuntime \
        <span class="hljs-string">&apos;org.junit.jupiter:junit-jupiter-engine:5.0.0&apos;</span>,
            <span class="hljs-string">&apos;org.junit.vintage:junit-vintage-engine:4.12.0&apos;</span>
}

task containerIntegTest(<span class="hljs-string">type:</span> Test) {
    Map&lt;String, Integer&gt; serviceMap = [ <span class="hljs-string">&quot;frontend&quot;</span> : <span class="hljs-number">8080</span>,
                                        <span class="hljs-string">&quot;uvprov&quot;</span> : <span class="hljs-number">4301</span>,
                                        <span class="hljs-string">&quot;provservice&quot;</span> : <span class="hljs-number">7030</span>,
                                        <span class="hljs-string">&quot;ldframe&quot;</span> : <span class="hljs-number">4303</span>,
                                        <span class="hljs-string">&quot;indexservice&quot;</span> : <span class="hljs-number">4304</span>,
                                        <span class="hljs-string">&quot;fuseki&quot;</span> : <span class="hljs-number">3030</span>,
                                        <span class="hljs-string">&quot;graphmanager&quot;</span> : <span class="hljs-number">4302</span>,
                                        <span class="hljs-string">&quot;es5&quot;</span>: <span class="hljs-number">9210</span>,
                                        <span class="hljs-string">&quot;rmlservice&quot;</span>: <span class="hljs-number">8090</span>,
                                        <span class="hljs-string">&quot;messagebroker&quot;</span>: <span class="hljs-number">5672</span>,
                                        <span class="hljs-string">&quot;messagebroker&quot;</span>: <span class="hljs-number">5671</span>,
                                        <span class="hljs-string">&quot;messagebroker&quot;</span>: <span class="hljs-number">4369</span>,
                                        <span class="hljs-string">&quot;testdata&quot;</span>: <span class="hljs-number">80</span>  ]
    ext.getHostPort = {services -&gt;
        serviceMap.each{ host, port -&gt;
            systemProperty <span class="hljs-string">&quot;${host}.port&quot;</span>, <span class="hljs-string">&quot;${port}&quot;</span>.toInteger()
            systemProperty <span class="hljs-string">&quot;${host}.host&quot;</span>, <span class="hljs-string">&quot;${host}&quot;</span>
        }
    }

    ext.removeHostPort = { services -&gt;
        serviceMap.each{ host, port -&gt;
            systemProperties.remove <span class="hljs-string">&quot;${host}.port&quot;</span>
            systemProperties.remove <span class="hljs-string">&quot;${host}.host&quot;</span>
         }
    }

    doFirst {
        getHostPort(serviceMap)
    }
    forkEvery = <span class="hljs-number">2</span>
    maxParallelForks = <span class="hljs-number">2</span>
    testLogging {
        showStackTraces = <span class="hljs-literal">true</span>
    }
    doLast {
        removeHostPort(serviceMap)
    }

}
</code></pre>
<h3 id="dockerfile-description">Dockerfile Description</h3>
<pre><code class="lang-Dockerfile"><span class="hljs-keyword">FROM</span> frekele/gradle:<span class="hljs-number">4.1</span>-jdk8

<span class="hljs-keyword">RUN</span><span class="bash"> apt-get update \
    &amp;&amp; apt-get install -y wget \
    &amp;&amp; apt-get clean
</span>
<span class="hljs-keyword">ENV</span> DOCKERIZE_VERSION v0.<span class="hljs-number">5.0</span>

<span class="hljs-keyword">RUN</span><span class="bash"> wget https://github.com/jwilder/dockerize/releases/download/<span class="hljs-variable">$DOCKERIZE_VERSION</span>/dockerize-linux-amd64-<span class="hljs-variable">$DOCKERIZE_VERSION</span>.tar.gz \
    &amp;&amp; tar -C /usr/<span class="hljs-built_in">local</span>/bin -xzvf dockerize-linux-amd64-<span class="hljs-variable">$DOCKERIZE_VERSION</span>.tar.gz \
    &amp;&amp; rm dockerize-linux-amd64-<span class="hljs-variable">$DOCKERIZE_VERSION</span>.tar.gz
</span>
<span class="hljs-keyword">RUN</span><span class="bash"> mkdir -p /tmp
</span>
<span class="hljs-keyword">WORKDIR</span><span class="bash"> /tmp
</span>
ARG UVreplaceDS

<span class="hljs-keyword">COPY</span><span class="bash"> src /tmp/src
</span><span class="hljs-keyword">COPY</span><span class="bash"> build.test.gradle /tmp/build.gradle
</span><span class="hljs-keyword">COPY</span><span class="bash"> runTests.sh /tmp
</span><span class="hljs-keyword">RUN</span><span class="bash"> chmod 700 /tmp/runTests.sh
</span>
<span class="hljs-keyword">COPY</span><span class="bash"> attx<span class="hljs-_">-l</span>-replaceds-<span class="hljs-variable">${UVreplaceDS}</span>.jar /tmp/attx<span class="hljs-_">-l</span>-replaceds-<span class="hljs-variable">${UVreplaceDS}</span>.jar
</span></code></pre>
<p><code>frekele/gradle</code> image contains all the components to run Gradle 4.1. <code>dockerize</code> is used by the <code>runTests.sh</code> script to poll ports on different containers as a crude way to determine whether the service each container provides is up or not. Note that only <code>build.test.gradle</code> file is copied to the image. Image also doesn&apos;t run any script by default, instead the dcompose Gradle plugin is used to attach a command  <code>runTests.sh</code> to the test container, which runs dockerized checks and runs the tests.</p>
<pre><code class="lang-bash"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-comment"># Wait for MySQL, the big number is because CI is slow.</span>
dockerize -wait tcp://mysql:3306 -timeout 240s
dockerize -wait http://fuseki:3030 -timeout 60s
dockerize -wait http://fuseki:3030 -timeout 60s
dockerize -wait http://graphmanager:4302/health -timeout 60s

<span class="hljs-built_in">echo</span>  <span class="hljs-string">&quot;Archiva repository URL: <span class="hljs-variable">$REPO</span>&quot;</span>

gradle -b /tmp/build.gradle -PartifactRepoURL=<span class="hljs-variable">$REPO</span> containerIntegTest
</code></pre>
<h3 id="configuring-jenkins">Configuring Jenkins</h3>
<p>Example configuration for Jenkins using pipeline plugin and declarative configurations:</p>
<pre><code class="lang-groovy">pipeline {
    agent any
    stages {
        stage(<span class="hljs-string">&apos;Checkout&apos;</span>) { <span class="hljs-comment">// for display purposes</span>
            steps {
                <span class="hljs-comment">// Get some code from a GitHub repository</span>
                git <span class="hljs-string">branch:</span> <span class="hljs-string">&apos;dev&apos;</span>, <span class="hljs-string">url:</span> <span class="hljs-string">&apos;https://github.com/ATTX-project/platform-deployment.git&apos;</span>
            }
        }
        stage(<span class="hljs-string">&apos;Compile/Package/Test&apos;</span>) {
            steps {
                echo sh (<span class="hljs-string">script:</span> <span class="hljs-string">&quot;${GRADLE_HOME}/bin/gradle --console=plain -b ${workspace}/build.gradle -PregistryURL=attx-dev:5000 -PartifactRepoURL=http://archiva:8080 -PtestEnv=CI :pd-feature-tests:clean :pd-feature-tests:runContainerTests&quot;</span>, <span class="hljs-string">returnStdout:</span> <span class="hljs-literal">true</span>)
            }
            post {
                always {
                    echo <span class="hljs-string">&apos;publishing reports&apos;</span>
                    publishHTML <span class="hljs-string">target:</span> [
<span class="hljs-symbol">                        allowMissing:</span> <span class="hljs-literal">false</span>,
<span class="hljs-symbol">                        alwaysLinkToLastBuild:</span> <span class="hljs-literal">false</span>,
<span class="hljs-symbol">                        keepAll:</span> <span class="hljs-literal">false</span>,
<span class="hljs-symbol">                        reportDir:</span> <span class="hljs-string">&apos;pd-feature-tests/build/reports/tests/integTest&apos;</span>,
<span class="hljs-symbol">                        reportFiles:</span> <span class="hljs-string">&apos;index.html&apos;</span>,
<span class="hljs-symbol">                        reportName:</span> <span class="hljs-string">&apos;pd-feature-tests-reports&apos;</span>
                        ]                    
                }
            }            
        }
    }     
}
</code></pre>
<p>Jenkins sets <code>testEnv=CI</code> in order to run the tests in a container. Report publication is configured as a <code>post</code> block of the build stage, so that is always run even if the build/test step fails.</p>
<h2 id="running-tests-against-custom-images">Running Tests Against Custom Images</h2>
<p>If you want to run tests against other that &apos;latest&apos; tag/versions of the images, do the following, where <code>testtag</code> is the tag/version needed for tests:</p>
<ul>
<li>Push your custom images to the private Docker repo with some tags (e.g. <code>attx-dev:5000/gm-api:testtag</code>).</li>
<li>Modify <code>dcompose</code> configuration int he <code>build.gradle</code> of the project you are working with by changing the tag of the selected images. For example:</li>
</ul>
<pre><code class="lang-groovy">dcompose {
...
  graphmanager {
    image = <span class="hljs-string">&apos;attx-dev:5000/gm-api:testtag&apos;</span>
  }
...
}
</code></pre>
<h2 id="developing-tests">Developing Tests</h2>
<p>When developing tests, it is easier to just run them inside the IDE and work on services on the <code>localhost</code> or use the <code>runIntegTests</code> tasks for running the integration tests with the containers exposing ports.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Build-Environment-Setup.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Build Environment Setup">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Containerized Testing","level":"6.4.3","depth":2,"next":{"title":"Reports","level":"7.1","depth":1,"ref":"","articles":[{"title":"CSC cPouta Cloud Services Report","level":"7.1.1","depth":2,"path":"CSC-cPouta-Cloud-Services-Report.md","ref":"CSC-cPouta-Cloud-Services-Report.md","articles":[]},{"title":"Building with (Py)Gradle","level":"7.1.2","depth":2,"path":"Building-with-Gradle.md","ref":"Building-with-Gradle.md","articles":[]},{"title":"Messaging Brokers Solutions Overview","level":"7.1.3","depth":2,"path":"Messaging-Brokers-Solutions.md","ref":"Messaging-Brokers-Solutions.md","articles":[]},{"title":"Service Discovery Solutions Overview","level":"7.1.4","depth":2,"path":"Service-Discovery-Solutions.md","ref":"Service-Discovery-Solutions.md","articles":[]},{"title":"Workflow Management Tools Overview","level":"7.1.5","depth":2,"path":"Workflow-Management-Tools.md","ref":"Workflow-Management-Tools.md","articles":[]},{"title":"API Gateway Solutions Overview","level":"7.1.6","depth":2,"path":"Solutions-API-Gateway.md","ref":"Solutions-API-Gateway.md","articles":[]}]},"previous":{"title":"Build Environment Setup","level":"6.4.2","depth":2,"path":"Build-Environment-Setup.md","ref":"Build-Environment-Setup.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["highlight","fontsettings","search","git-author","gitversion","copy-code-button"],"pluginsConfig":{"gitversion":{},"git-author":{"position":"top","modifyTpl":"Current page last modified at: {timeStamp}","createTpl":false,"timeStampFormat":"DD-MMM-YYYY HH:mm:ss"},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"family":"sans","size":2,"theme":"white"},"fontSettings":{"size":1},"highlight":{},"copy-code-button":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Containerized-testing.md","mtime":"2017-12-07T12:33:30.439Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2017-12-07T12:33:47.200Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    

    </body>
</html>

