
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Containerized Testing Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-git-author/style.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="Build-Environment-Setup.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">ATTX Project</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Applications and Use Cases
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="Use-case-Infrastructures-and-publications.html">
            
                <a href="Use-case-Infrastructures-and-publications.html">
            
                    
                    UC1 - Infrastructure and Publications
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="Use-case-Jyvaskyla.html">
            
                <a href="Use-case-Jyvaskyla.html">
            
                    
                    UC2 - Parallel Publication Dashboard
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="Use-case-Metax.html">
            
                <a href="Use-case-Metax.html">
            
                    
                    UC3 - Metax
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="ATTX-Architecture-Overview.html">
            
                <a href="ATTX-Architecture-Overview.html">
            
                    
                    ATTX Architecture Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="ATTX-Broker-Deployment.html">
            
                <a href="ATTX-Broker-Deployment.html">
            
                    
                    ATTX Broker Deployment
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" >
            
                <span>
            
                    
                    Run on Single Machine PC/Mac/VM
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1.1" data-path="Building-Docker-application-stacks-in-Swarm-Mode.html">
            
                <a href="Building-Docker-application-stacks-in-Swarm-Mode.html">
            
                    
                    Building Swarm Mode on a PC/Mac
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.2" data-path="Running-the-ATTX-containerised-application-stack-in-your-own-PC-or-Mac.html">
            
                <a href="Running-the-ATTX-containerised-application-stack-in-your-own-PC-or-Mac.html">
            
                    
                    Running the ATTX Stack on a PC/Mac
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.2" >
            
                <span>
            
                    
                    Run on Distributed/Cloud
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.2.1" data-path="Provisioning-ATTX-Components-on-CSC-Open-Stack-cPouta.html">
            
                <a href="Provisioning-ATTX-Components-on-CSC-Open-Stack-cPouta.html">
            
                    
                    Provisioning ATTX Components on CSC Open Stack (cPouta)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.2" data-path="Deploying-ATTX-Components-on-Docker-Swarm.html">
            
                <a href="Deploying-ATTX-Components-on-Docker-Swarm.html">
            
                    
                    Deploying ATTX Components on Docker Swarm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.3" data-path="Applying-Rolling-Updates-to-services-in-Docker-Swarm.html">
            
                <a href="Applying-Rolling-Updates-to-services-in-Docker-Swarm.html">
            
                    
                    Applying Rolling Updates to Services in Docker Swarm
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="Workflow-Component.html">
            
                <a href="Workflow-Component.html">
            
                    
                    Workflow Component
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="ETL-Artifacts.html">
            
                <a href="ETL-Artifacts.html">
            
                    
                    ETL Artifacts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="Unified-Views-plugins.html">
            
                <a href="Unified-Views-plugins.html">
            
                    
                    UnifiedViews Plugins
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="Workflow-API.html">
            
                <a href="Workflow-API.html">
            
                    
                    Workflow API
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="Graph-Component.html">
            
                <a href="Graph-Component.html">
            
                    
                    Graph Component
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="Graph-Manager-API.html">
            
                <a href="Graph-Manager-API.html">
            
                    
                    Graph Manager API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="Graph-Store.html">
            
                <a href="Graph-Store.html">
            
                    
                    Graph Store
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.2.1" data-path="Data-Model.html">
            
                <a href="Data-Model.html">
            
                    
                    Ontology/Data model
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.2" data-path="Namespaces.html">
            
                <a href="Namespaces.html">
            
                    
                    Graph Namespaces
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.3" data-path="Linking-Strategies.html">
            
                <a href="Linking-Strategies.html">
            
                    
                    Linking Strategies
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="Distribution-Component.html">
            
                <a href="Distribution-Component.html">
            
                    
                    Distribution Component
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="ElasticSearch-with-Siren.html">
            
                <a href="ElasticSearch-with-Siren.html">
            
                    
                    ElasticSearch with Siren
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="ElasticSearch-5.html">
            
                <a href="ElasticSearch-5.html">
            
                    
                    ElasticSearch 5.x
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="ServiceDiscovery-Implementation.html">
            
                <a href="ServiceDiscovery-Implementation.html">
            
                    
                    Service Discovery Implementation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="Consul-for-Service-Discovery-on-Docker-Swarm.html">
            
                <a href="Consul-for-Service-Discovery-on-Docker-Swarm.html">
            
                    
                    Consul for Service Discovery on Docker Swarm
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">User Guide</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="User-Guide-Administrator.html">
            
                <a href="User-Guide-Administrator.html">
            
                    
                    Data Administrator's User guide
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Project Guidelines</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="Feature-roadmap.html">
            
                <a href="Feature-roadmap.html">
            
                    
                    Feature Roadmap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="Release-Plan.html">
            
                <a href="Release-Plan.html">
            
                    
                    Release Plan
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="Project-Development-Environment.html">
            
                <a href="Project-Development-Environment.html">
            
                    
                    Project Development Environment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="CI-CD-Enviroment.html">
            
                <a href="CI-CD-Enviroment.html">
            
                    
                    CI/CD Enviroment
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.4.1" data-path="Jenkins-CI.html">
            
                <a href="Jenkins-CI.html">
            
                    
                    Jenkins CI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4.2" data-path="Build-Environment-Setup.html">
            
                <a href="Build-Environment-Setup.html">
            
                    
                    Build Environment Setup
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="3.4.3" data-path="Containerized-testing.html">
            
                <a href="Containerized-testing.html">
            
                    
                    Containerized Testing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Project Contributions</li>
        
        
    
        <li class="chapter " data-level="4.1" >
            
                <span>
            
                    
                    Reports
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="Deploying-ATTX-SB-on-Kontena.html">
            
                <a href="Deploying-ATTX-SB-on-Kontena.html">
            
                    
                    Deploying the ATTX Semantic Broker on Kontena
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="CSC-cPouta-Cloud-Services-Report.html">
            
                <a href="CSC-cPouta-Cloud-Services-Report.html">
            
                    
                    CSC cPouta Cloud Services Report
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3" data-path="Building-with-Gradle.html">
            
                <a href="Building-with-Gradle.html">
            
                    
                    Building with (Py)Gradle
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4" data-path="Messaging-Brokers-Solutions.html">
            
                <a href="Messaging-Brokers-Solutions.html">
            
                    
                    Messaging Brokers Solutions Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5" data-path="Service-Discovery-Solutions.html">
            
                <a href="Service-Discovery-Solutions.html">
            
                    
                    Service Discovery Solutions Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6" data-path="Workflow-Management-Tools.html">
            
                <a href="Workflow-Management-Tools.html">
            
                    
                    Workflow Management Tools Overview
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.2" >
            
                <span>
            
                    
                    Presentations
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.2.1" data-path="ELAG-2017.html">
            
                <a href="ELAG-2017.html">
            
                    
                    ELAG2017
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.2" data-path="SWIB-2017.html">
            
                <a href="SWIB-2017.html">
            
                    
                    SWIB2017
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="Open-Contributions.html">
            
                <a href="Open-Contributions.html">
            
                    
                    Open Source Contributions
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="5.1" >
            
                <a target="_blank" href="https://www.helsinki.fi/en/projects/attx-2016">
            
                    
                    ATTX website
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Containerized Testing</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div class="git-author-container git-author-top"><div class="modified">Current page last modified at: 15-Jun-2017 08:04:25</div></div><h1 id="containerised-testing">Containerised Testing</h1>
<p>This page describes the necessary steps required to run integration/BDD tests within a container or local environment alongside any required services running in their own containers.</p>
<!-- TOC START min:1 max:3 link:true update:false -->
<ul>
<li><a href="#testing-workflow">Testing Workflow</a></li>
<li><a href="#testing-with-gradle">Testing with Gradle</a></li>
<li><a href="#structure-of-feature-test-images">Structure of feature-test images</a><ul>
<li><a href="#runtestssh-script">runTests.sh script</a></li>
<li><a href="#gradle-build-files">Gradle build files</a></li>
<li><a href="#dockerfile">Dockerfile</a></li>
<li><a href="#configuring-jenkins">Configuring Jenkins</a></li>
</ul>
</li>
<li><a href="#running-tests-against-custom-images">Running tests against custom images</a></li>
<li><a href="#developing-tests">Developing tests</a></li>
</ul>
<!-- TOC END -->
<p>In ATTX github repositories, IT/BDD (tests from now on) should be located in separate <code>x-feature-tests</code> projects (e.g. <code>gc-feature-tests</code>).</p>
<h2 id="testing-workflow">Testing Workflow</h2>
<p>Overview of the steps performed during the test suite:</p>
<ul>
<li>Start all required Semantic Broker containers</li>
<li>Wait for the services to come up</li>
<li>Build test code</li>
<li>Build test container (only during the containerised testing task)</li>
<li>Start test container (only during the containerised testing task)</li>
<li>Run tests</li>
<li>Export reports to the host machine</li>
<li>Stop all containers</li>
<li>The build is Successful or Failed depending on the results form the test container</li>
</ul>
<h2 id="testing-with-gradle">Testing with Gradle</h2>
<p>There are two tasks for running the tests:</p>
<ul>
<li><code>runIntegTests</code> -  for running the test in the local environment with all the ports exposed, thus allowing for rapid development; It will also start the containers needed, by default they will expose ports;</li>
<li><code>runContainerTests</code> - for running tests in the CI environment or a closed test setup, and for this one needs the Gradle property <code>-PtestEnv=CI</code>. This task will run the tests inside a container on the same network as the other containers without the need of exposing all the ports.</li>
</ul>
<p>Running the tests inside the container:</p>
<ul>
<li><code>gradle -PregistryURL=attx-dev:5000 -PsnapshotRepoURL=http://attx-dev:8081/repository/attx-releases -PtestEnv=CI clean runContainerTests</code></li>
<li><code>gradle -PregistryURL=attx-dev:5000 -PsnapshotRepoURL=http://attx-dev:8081 -Penv=dev -PtestEnv=CI clean runContainerTests</code> (for pd-feature-tests)</li>
</ul>
<p>Run the test locally without containers and exposing the ports:</p>
<ul>
<li><p><code>gradle -PregistryURL=attx-dev:5000 -PsnapshotRepoURL=http://attx-dev:8081/repository/attx-releases clean runIntegTests</code></p>
</li>
<li><p><code>gradle -PregistryURL=attx-dev:5000  -PsnapshotRepoURL=http://attx-dev:8081 -Penv=dev clean runIntegTests</code> (for pd-feature-tests)</p>
</li>
</ul>
<p>Test reports are exported to the folder configured in <code>copyReportFiles</code> task (default <code>$buildDir/reports/</code>).</p>
<h2 id="structure-of-feature-test-images">Structure of Feature-test Images</h2>
<h3 id="runtestssh-script">runTests.sh Script</h3>
<p>This script is the starting point for a <code>testContainer</code>. It first checks and waits (for a limited time) for certain ports in the network to become available and then runs the test suite.
<strong>TO DO</strong>
In the future, the goal is to use Service discovery component to query for up-and-running services.</p>
<p>Example: Waiting for services to be available:</p>
<pre><code class="lang-bash">dockerize -wait tcp://mysql:3306 -timeout 240s
dockerize -wait http://fuseki:3030 -timeout 60s
dockerize -wait http://gmapi:4302/health -timeout 60s
</code></pre>
<p><a href="https://github.com/jwilder/dockerize" target="_blank">Dockerize (Github)</a></p>
<p>These checks and waits are complementary to the ones done in the Gradle script and the reason is that some tests need to have some fixture in place (e.g. ATTX DPU) which also wait for other services to start. Thus the tests need to have everything ready before starting, meaning the last dependent container needs to finish before running.</p>
<p>If the time-out is reached and the service is still not available, the process exits with status code 1.</p>
<h3 id="gradle-build-files">Gradle Build Files</h3>
<p>Test project contains two Gradle configurations, one for developing tests and managing containers and the other one for running tests inside the container; these are <code>build.gradle</code> and <code>build.test.gradle</code> respectively.</p>
<p><strong>build.gradle</strong></p>
<p>Example of the most relevant parts:</p>
<pre><code class="lang-groovy"><span class="hljs-keyword">if</span> (!project.hasProperty(<span class="hljs-string">&quot;testEnv&quot;</span>) || project.testEnv == <span class="hljs-string">&quot;dev&quot;</span>) {
    ext.testSet = <span class="hljs-string">&quot;localhost&quot;</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (project.testEnv == <span class="hljs-string">&quot;CI&quot;</span>){
    ext.testSet = <span class="hljs-string">&quot;container&quot;</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> GradleException(<span class="hljs-string">&quot;Build project environment option not recognised.&quot;</span>)
}

ext {
    testImageWF = <span class="hljs-string">&quot;latest&quot;</span>
    testImageGM = <span class="hljs-string">&quot;latest&quot;</span>
    testImageES5 = <span class="hljs-string">&quot;latest&quot;</span>
}

dcompose {
    createComposeFile.useTags = <span class="hljs-literal">true</span>
    registry (<span class="hljs-string">&quot;$registryURL&quot;</span>) {
        <span class="hljs-comment">// no user/pass</span>
    }
    networks {
      gcTest
    }

    es5 {
        forcePull = <span class="hljs-literal">true</span>
        forceRemoveImage = <span class="hljs-literal">true</span>
        image = <span class="hljs-string">&quot;${imageRepo}:${imageRepoPort}/attx-es5:${testImageES5}&quot;</span>
        networks = [gcTest]
        hostName = <span class="hljs-string">&apos;es5&apos;</span>
        <span class="hljs-keyword">if</span> (testSet == <span class="hljs-string">&quot;localhost&quot;</span>) {
            portBindings = [<span class="hljs-string">&apos;9210:9210&apos;</span>, <span class="hljs-string">&apos;9310:9310&apos;</span>]
        }
    }

    wfapi {
        forcePull = <span class="hljs-literal">true</span>
        forceRemoveImage = <span class="hljs-literal">true</span>
        image = <span class="hljs-string">&quot;${imageRepo}:${imageRepoPort}/wf-api:${testImageWF}&quot;</span>
        dependsOn = [mysql]
        networks = [gcTest]
        hostName = <span class="hljs-string">&apos;wfapi&apos;</span>
        <span class="hljs-keyword">if</span> (testSet == <span class="hljs-string">&quot;localhost&quot;</span>) {
            portBindings = [<span class="hljs-string">&apos;4301:4301&apos;</span>]
        }
    }

    gmapi {
        forcePull = <span class="hljs-literal">true</span>
        forceRemoveImage = <span class="hljs-literal">true</span>
        image = <span class="hljs-string">&quot;${imageRepo}:${imageRepoPort}/gm-api:${testImageGM}&quot;</span>
        dependsOn = [wfapi, es5]
        networks = [gcTest]
        hostName = <span class="hljs-string">&apos;gmapi&apos;</span>
        <span class="hljs-keyword">if</span> (testSet == <span class="hljs-string">&quot;localhost&quot;</span>) {
            portBindings = [<span class="hljs-string">&apos;4302:4302&apos;</span>]
        }
    }

    test {
        ignoreExitCode = <span class="hljs-literal">true</span>
        baseDir = file(<span class="hljs-string">&apos;.&apos;</span>)
        dockerFilename = <span class="hljs-string">&apos;Dockerfile&apos;</span>
        <span class="hljs-keyword">if</span> (testSet == <span class="hljs-string">&quot;container&quot;</span>) {
            binds = [<span class="hljs-string">&quot;/var/run/docker.sock:/run/docker.sock&quot;</span>]
        }
        dependsOn = [gmapi] <span class="hljs-comment">// This dependency is not really needed however it reminds the scope of the tests.</span>
        command = [<span class="hljs-string">&apos;sh&apos;</span>, <span class="hljs-string">&apos;-c&apos;</span>, <span class="hljs-string">&apos;/tmp/runTests.sh&apos;</span>]
        waitForCommand = <span class="hljs-literal">true</span>
        forceRemoveImage = <span class="hljs-literal">true</span>
        attachStdout = <span class="hljs-literal">true</span> <span class="hljs-comment">// to view the output in the console</span>
        networks = [gcTest]
    }
}

task copyReportFiles(<span class="hljs-string">type:</span> DcomposeCopyFileFromContainerTask) {
    service = dcompose.test
    containerPath = <span class="hljs-string">&apos;/tmp/build/reports/tests&apos;</span>
    destinationDir = file(<span class="hljs-string">&quot;build/reports/&quot;</span>)
    cleanDestinationDir = <span class="hljs-literal">false</span>
}

startTestContainer.finalizedBy copyReportFiles

shadowJar {
    classifier = <span class="hljs-string">&apos;tests&apos;</span>
    from sourceSets.test.output
    configurations = [project.configurations.testRuntime]
}

<span class="hljs-comment">// making sure the that fresh build of test classes is done before building the image</span>
<span class="hljs-comment">// Other prerequisites for the tests (e.g. artifacts) should be added here.</span>
buildTestImage.dependsOn shadowJar
buildTestImage.dependsOn testClasses

task checkDPUDone(<span class="hljs-string">type:</span> DockerWaitContainer) {
    dependsOn startGmapiContainer
    targetContainerId {dcompose.attxdpus.containerId}
    doLast{
        <span class="hljs-keyword">if</span>(getExitCode() != <span class="hljs-number">0</span>) {
            println <span class="hljs-string">&quot;ATTX DPU Container failed with exit code \${getExitCode()}&quot;</span>
        } <span class="hljs-keyword">else</span> {
            println <span class="hljs-string">&quot;Everything is peachy.&quot;</span>
        }
    }
}

startTestContainer.dependsOn checkDPUDone

task runContainerTests {
    dependsOn startTestContainer
    finalizedBy removeImages
    doLast {
        <span class="hljs-keyword">if</span>(dcompose.test.exitCode != <span class="hljs-number">0</span>){ <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> GradleException(<span class="hljs-string">&quot;Tests within the container Failed!&quot;</span>) }
    }
}
</code></pre>
<p><code>dcompose</code> task configuration is first used to reference all the images required by the tests. In the example, test will require only the container (e.g. <code>gmapi</code>) that is the object of the tests, meanwhile the container that is the object of the tests will require the additional containers (<code>fuseki</code>, <code>essiren</code> and <code>gmapi</code>) in addition to the test container.
Service configurations should include at least <code>image</code> and in order to run the tests in a local environment the <code>portBindings</code> properties. Test container configuration is mostly same for all the test projects.</p>
<p>Rest of the configuration is the same for all the test projects (assuming that test container is always called <code>test</code>). <code>copyReportFiles</code> task copies report files from inside the container to the build/from-container directory.
<code>ShadowJar</code> task create one big jar with all the dependencies required to run the tests, which allows us to run Gradle within in the container in offline mode, which does not trigger dependency downloads (faster). Other option would have been to attach a volume with the preloaded dependencies, but that would also required maintenance.   </p>
<p><code>checkDPUDone</code> waits for the ATTX DPUS to be added to the front-end where there is a need for such test fixtures. The ATTX DPU waits for MySQL  (for about 4 minutes to be up) in order to add the DPU. If everything is OK the exit code of that container will be (By convention, an &apos;exit 0&apos; indicates success - <a href="http://www.tldp.org/LDP/abs/html/exit-status.html" target="_blank">http://www.tldp.org/LDP/abs/html/exit-status.html</a>). The same strategy is used to check the Tests fail or not inside the container - if the exit code is <code>0</code> the tests were successful if not the tests failed.</p>
<p><strong>build.test.gradle</strong></p>
<p>This is a very minimal build file that basically only includes dependency configuration.</p>
<p>The system properties are required to be set in the container and these need to be the same as the <code>hostName</code> of the containers so that are no conflicts when accessing them in the network. The solution of having them inside the Gradle configurations instead of the test code is a decision of keeping the implementation independent of the configuration of the containers.</p>
<p>Another reason is to allow for the tests to be run in local environment, meaning the ports are exposed and the tests need to take into consideration that the requests make inside the network between containers need to be done under the <code>hostName</code> of the specific containers (e.g. no <a href="http://localhost:4301/health" target="_blank">http://localhost:4301/health</a> but instead <a href="http://wfapi:4301/health" target="_blank">http://wfapi:4301/health</a>).</p>
<pre><code class="lang-groovy">plugins {
    id <span class="hljs-string">&quot;java&quot;</span>
}

dependencies {
    testCompile fileTree(<span class="hljs-string">dir:</span> <span class="hljs-string">&apos;build/libs&apos;</span>, <span class="hljs-string">include:</span> [<span class="hljs-string">&apos;*.jar&apos;</span>])
}

task integTest(<span class="hljs-string">type:</span> Test){
    doFirst {
        systemProperty <span class="hljs-string">&apos;frontend.port&apos;</span>, <span class="hljs-number">8080</span>
        systemProperty <span class="hljs-string">&apos;frontend.host&apos;</span>, <span class="hljs-string">&apos;frontend&apos;</span>
        systemProperty <span class="hljs-string">&apos;wfapi.port&apos;</span>, <span class="hljs-number">4301</span>
        systemProperty <span class="hljs-string">&apos;wfapi.host&apos;</span>, <span class="hljs-string">&apos;wfapi&apos;</span>
        systemProperty <span class="hljs-string">&apos;fuseki.port&apos;</span>, <span class="hljs-number">3030</span>
        systemProperty <span class="hljs-string">&apos;fuseki.host&apos;</span>, <span class="hljs-string">&apos;fuseki&apos;</span>
        systemProperty <span class="hljs-string">&apos;gmapi.port&apos;</span>, <span class="hljs-number">4302</span>
        systemProperty <span class="hljs-string">&apos;gmapi.host&apos;</span>, <span class="hljs-string">&apos;gmapi&apos;</span>
        systemProperty <span class="hljs-string">&apos;essiren.port&apos;</span>, <span class="hljs-number">9200</span>
        systemProperty <span class="hljs-string">&apos;essiren.tcp&apos;</span>, <span class="hljs-number">9300</span>
        systemProperty <span class="hljs-string">&apos;essiren.host&apos;</span>, <span class="hljs-string">&apos;essiren&apos;</span>
        systemProperty <span class="hljs-string">&apos;es5.port&apos;</span>, <span class="hljs-number">9210</span>
        systemProperty <span class="hljs-string">&apos;es5.host&apos;</span>, <span class="hljs-string">&apos;es5&apos;</span>
    }
    forkEvery = <span class="hljs-number">2</span>
    maxParallelForks = <span class="hljs-number">2</span>
    testLogging {
        showStackTraces = <span class="hljs-literal">true</span>
    }
    doLast {
        systemProperties.remove <span class="hljs-string">&apos;frontend.port&apos;</span>
        systemProperties.remove <span class="hljs-string">&apos;frontend.host&apos;</span>
        systemProperties.remove <span class="hljs-string">&apos;wfapi.port&apos;</span>
        systemProperties.remove <span class="hljs-string">&apos;wfapi.host&apos;</span>
        systemProperties.remove <span class="hljs-string">&apos;fuseki.port&apos;</span>
        systemProperties.remove <span class="hljs-string">&apos;fuseki.host&apos;</span>
        systemProperties.remove <span class="hljs-string">&apos;gmapi.port&apos;</span>
        systemProperties.remove <span class="hljs-string">&apos;gmapi.host&apos;</span>
        systemProperties.remove <span class="hljs-string">&apos;essiren.port&apos;</span>
        systemProperties.remove <span class="hljs-string">&apos;essiren.tcp&apos;</span>
        systemProperties.remove <span class="hljs-string">&apos;essiren.host&apos;</span>
        systemProperties.remove <span class="hljs-string">&apos;es5.port&apos;</span>
        systemProperties.remove <span class="hljs-string">&apos;es5.host&apos;</span>
    }
}
</code></pre>
<p>Dependencies are loaded from the &#xFC;berjar created by the <code>shadowJar</code> task in the <code>build.gradle</code>. This jar and classes directory includes everything that is needed to run the tests, so we can actually run Gradle in the offline mode (<code>--offline</code>). Building step is faster, since we don&apos;t have to download all the dependencies every time the tests are run.</p>
<h3 id="dockerfile-description">Dockerfile Description</h3>
<pre><code class="lang-Dockerfile"><span class="hljs-keyword">FROM</span> frekele/gradle:<span class="hljs-number">3.3</span>-jdk8

<span class="hljs-keyword">RUN</span><span class="bash"> apt-get update \
    &amp;&amp; apt-get install -y wget \
    &amp;&amp; apt-get clean
</span>
<span class="hljs-keyword">ENV</span> DOCKERIZE_VERSION v0.<span class="hljs-number">3.0</span>

<span class="hljs-keyword">RUN</span><span class="bash"> wget https://github.com/jwilder/dockerize/releases/download/<span class="hljs-variable">$DOCKERIZE_VERSION</span>/dockerize-linux-amd64-<span class="hljs-variable">$DOCKERIZE_VERSION</span>.tar.gz \
    &amp;&amp; tar -C /usr/<span class="hljs-built_in">local</span>/bin -xzvf dockerize-linux-amd64-<span class="hljs-variable">$DOCKERIZE_VERSION</span>.tar.gz \
    &amp;&amp; rm dockerize-linux-amd64-<span class="hljs-variable">$DOCKERIZE_VERSION</span>.tar.gz
</span>
<span class="hljs-keyword">RUN</span><span class="bash"> mkdir -p /tmp/
</span>
<span class="hljs-keyword">WORKDIR</span><span class="bash"> /tmp/
</span>
<span class="hljs-keyword">COPY</span><span class="bash"> build /tmp/build
</span><span class="hljs-keyword">COPY</span><span class="bash"> build.test.gradle /tmp/build.gradle
</span><span class="hljs-keyword">COPY</span><span class="bash"> runTests.sh /tmp/
</span><span class="hljs-keyword">RUN</span><span class="bash"> chmod 700 /tmp/runTests.sh
</span></code></pre>
<p><code>frekele/gradle</code> image contains all the components to run Gradle 3.3. <code>dockerize</code> is used by the <code>runTests.sh</code> script to poll ports on different containers as a crude way to determine whether the service each container provides is up or not. Note that only <code>build.test.gradle</code> file is copied to the image. Image also doesn&apos;t run any script by default, instead the dcompose Gradle plugin is used to attach a command  <code>runTests.sh</code> to the test container, which runs dockerized checks and runs the tests.</p>
<h3 id="configuring-jenkins">Configuring Jenkins</h3>
<p>Example configuration for Jenkins using pipeline plugin and declarative configurations:</p>
<pre><code class="lang-groovy">pipeline {
    agent any
    stages {
        stage(<span class="hljs-string">&apos;Checkout&apos;</span>) { <span class="hljs-comment">// for display purposes</span>
            steps {
                <span class="hljs-comment">// Get some code from a GitHub repository</span>
                git <span class="hljs-string">branch:</span> <span class="hljs-string">&apos;dev&apos;</span>, <span class="hljs-string">url:</span> <span class="hljs-string">&apos;https://github.com/ATTX-project/platform-deployment.git&apos;</span>
            }
        }
        stage(<span class="hljs-string">&apos;Compile/Package/Test&apos;</span>) {
            steps {
                echo sh (<span class="hljs-string">script:</span> <span class="hljs-string">&quot;${GRADLE_HOME}/bin/gradle --console=plain -b ${workspace}/build.gradle -PregistryURL=attx-dev:5000 -PartifactRepoURL=http://archiva:8080 -PtestEnv=CI :pd-feature-tests:clean :pd-feature-tests:runContainerTests&quot;</span>, <span class="hljs-string">returnStdout:</span> <span class="hljs-literal">true</span>)
            }
            post {
                always {
                    echo <span class="hljs-string">&apos;publishing reports&apos;</span>
                    publishHTML <span class="hljs-string">target:</span> [
<span class="hljs-symbol">                        allowMissing:</span> <span class="hljs-literal">false</span>,
<span class="hljs-symbol">                        alwaysLinkToLastBuild:</span> <span class="hljs-literal">false</span>,
<span class="hljs-symbol">                        keepAll:</span> <span class="hljs-literal">false</span>,
<span class="hljs-symbol">                        reportDir:</span> <span class="hljs-string">&apos;pd-feature-tests/build/reports/tests/integTest&apos;</span>,
<span class="hljs-symbol">                        reportFiles:</span> <span class="hljs-string">&apos;index.html&apos;</span>,
<span class="hljs-symbol">                        reportName:</span> <span class="hljs-string">&apos;pd-feature-tests-reports&apos;</span>
                        ]                    
                }
            }            
        }
    }     
}
</code></pre>
<p>Jenkins sets <code>testEnv=CI</code> in order to run the tests in a container. Report publication is configured as a <code>post</code> block of the build stage, so that is always run even if the build/test step fails.</p>
<h2 id="running-tests-against-custom-images">Running Tests Against Custom Images</h2>
<p>If you want to run tests against other that &apos;latest&apos; tag/versions of the images, do the following, where <code>testtag</code> is the tag/version needed for tests:</p>
<ul>
<li>Push your custom images to the private Docker repo with some tags (e.g. <code>attx-dev:5000/gm-api:testtag</code>).</li>
<li>Modify <code>dcompose</code> configuration int he <code>build.gradle</code> of the project you are working with by changing the tag of the selected images. For example:</li>
</ul>
<pre><code class="lang-groovy">dcompose {
...
  gmapi {
    image = <span class="hljs-string">&apos;attx-dev:5000/gm-api:testtag&apos;</span>
  }
...
}
</code></pre>
<h2 id="developing-tests">Developing Tests</h2>
<p>When developing tests, it is easier to just run them inside the IDE and work on services on the <code>localhost</code> or use the <code>runIntegTests</code> tasks for running the integration tests with the containers exposing ports.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Build-Environment-Setup.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Build Environment Setup">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Containerized Testing","level":"3.4.3","depth":2,"next":{"title":"Reports","level":"4.1","depth":1,"ref":"","articles":[{"title":"Deploying the ATTX Semantic Broker on Kontena","level":"4.1.1","depth":2,"path":"Deploying-ATTX-SB-on-Kontena.md","ref":"Deploying-ATTX-SB-on-Kontena.md","articles":[]},{"title":"CSC cPouta Cloud Services Report","level":"4.1.2","depth":2,"path":"CSC-cPouta-Cloud-Services-Report.md","ref":"CSC-cPouta-Cloud-Services-Report.md","articles":[]},{"title":"Building with (Py)Gradle","level":"4.1.3","depth":2,"path":"Building-with-Gradle.md","ref":"Building-with-Gradle.md","articles":[]},{"title":"Messaging Brokers Solutions Overview","level":"4.1.4","depth":2,"path":"Messaging-Brokers-Solutions.md","ref":"Messaging-Brokers-Solutions.md","articles":[]},{"title":"Service Discovery Solutions Overview","level":"4.1.5","depth":2,"path":"Service-Discovery-Solutions.md","ref":"Service-Discovery-Solutions.md","articles":[]},{"title":"Workflow Management Tools Overview","level":"4.1.6","depth":2,"path":"Workflow-Management-Tools.md","ref":"Workflow-Management-Tools.md","articles":[]}]},"previous":{"title":"Build Environment Setup","level":"3.4.2","depth":2,"path":"Build-Environment-Setup.md","ref":"Build-Environment-Setup.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["highlight","fontsettings","search","git-author","gitversion"],"pluginsConfig":{"gitversion":{},"git-author":{"position":"top","modifyTpl":"Current page last modified at: {timeStamp}","createTpl":false,"timeStampFormat":"DD-MMM-YYYY HH:mm:ss"},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"family":"sans","size":2,"theme":"white"},"fontSettings":{"size":1},"highlight":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Containerized-testing.md","mtime":"2017-06-19T07:28:53.363Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2017-07-25T06:42:30.456Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    

    </body>
</html>

